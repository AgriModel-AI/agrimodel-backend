{% extends 'reports/base_report.html' %}
{% set report_title = 'User Engagement & Growth' %}

{% block report_content %}
    <div class="report-section">
        <h2 class="text-primary mb-4">New Users Trend</h2>
        <div class="chart-container">
            <canvas id="newUsersChart"></canvas>
        </div>
        <div class="table-container">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Month</th>
                        <th>New Users</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data.new_users_trend %}
                    <tr>
                        <td>{{ item.year }}</td>
                        <td>{{ item.month }}</td>
                        <td>{{ item.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="report-section">
        <h2 class="text-primary mb-4">Active Users Daily Trend</h2>
        <div class="chart-container">
            <canvas id="activeUsersChart"></canvas>
        </div>
        <div class="table-container">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Active Users</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data.active_users %}
                    <tr>
                        <td>{{ item.date }}</td>
                        <td>{{ item.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="report-section">
                <h2 class="text-primary mb-4">User Roles Distribution</h2>
                <div class="chart-container">
                    <canvas id="userRolesChart"></canvas>
                </div>
                <div class="table-container">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Role</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in data.user_roles %}
                            <tr>
                                <td>{{ item.role }}</td>
                                <td>{{ item.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="report-section">
                <h2 class="text-primary mb-4">Verification Status</h2>
                <div class="chart-container">
                    <canvas id="verificationChart"></canvas>
                </div>
                <div class="table-container">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in data.verification_status %}
                            <tr>
                                <td>{{ item.status }}</td>
                                <td>{{ item.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block additional_scripts %}
<script>
    // Initialize charts
    document.addEventListener('DOMContentLoaded', function() {
        // New Users Trend Chart
        const newUsersData = {{ data.new_users_trend|tojson }};
        const newUsersLabels = newUsersData.map(item => `${item.year}-${item.month}`);
        const newUsersCounts = newUsersData.map(item => item.count);
        
        new Chart(document.getElementById('newUsersChart'), {
            type: 'bar',
            data: {
                labels: newUsersLabels,
                datasets: [{
                    label: 'New Users',
                    data: newUsersCounts,
                    backgroundColor: '#2e7d32',
                    borderColor: '#2e7d32',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Active Users Chart
        const activeUsersData = {{ data.active_users|tojson }};
        const activeUsersLabels = activeUsersData.map(item => item.date);
        const activeUsersCounts = activeUsersData.map(item => item.count);
        
        new Chart(document.getElementById('activeUsersChart'), {
            type: 'line',
            data: {
                labels: activeUsersLabels,
                datasets: [{
                    label: 'Active Users',
                    data: activeUsersCounts,
                    backgroundColor: 'rgba(46, 125, 50, 0.2)',
                    borderColor: '#2e7d32',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // User Roles Chart
        const userRolesData = {{ data.user_roles|tojson }};
        const rolesLabels = userRolesData.map(item => item.role);
        const rolesCounts = userRolesData.map(item => item.count);
        
        new Chart(document.getElementById('userRolesChart'), {
            type: 'pie',
            data: {
                labels: rolesLabels,
                datasets: [{
                    data: rolesCounts,
                    backgroundColor: [
                        '#2e7d32', '#a5d6a7', '#f57c00', '#ffcc80', '#78909c'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
        
        // Verification Status Chart
        const verificationData = {{ data.verification_status|tojson }};
        const statusLabels = verificationData.map(item => item.status);
        const statusCounts = verificationData.map(item => item.count);
        
        new Chart(document.getElementById('verificationChart'), {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusCounts,
                    backgroundColor: [
                        '#2e7d32', '#f57c00'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    });
</script>
{% endblock %}