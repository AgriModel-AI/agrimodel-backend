{% extends 'reports/base_report.html' %}
{% set report_title = 'Plant Disease Analytics' %}

{% block report_content %}
    <div class="report-section">
        <h2 class="text-primary mb-4">Most Common Diseases</h2>
        <div class="chart-container">
            <canvas id="commonDiseasesChart"></canvas>
        </div>
        <div class="table-container">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Disease</th>
                        <th>Detection Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data.common_diseases %}
                    <tr>
                        <td>{{ item.name }}</td>
                        <td>{{ item.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="report-section">
        <h2 class="text-primary mb-4">Disease Trends Over Time</h2>
        <div class="chart-container" style="height: 400px;">
            <canvas id="diseaseTrendsChart"></canvas>
        </div>
        <div class="table-container">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Disease</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data.disease_trends %}
                    <tr>
                        <td>{{ item.date }}</td>
                        <td>{{ item.disease }}</td>
                        <td>{{ item.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="report-section">
                <h2 class="text-primary mb-4">Detection Results</h2>
                <div class="chart-container">
                    <canvas id="detectionRatioChart"></canvas>
                </div>
                <div class="table-container">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in data.detection_ratio %}
                            <tr>
                                <td>{{ item.status }}</td>
                                <td>{{ item.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="report-section">
                <h2 class="text-primary mb-4">Model Version Performance</h2>
                <div class="chart-container">
                    <canvas id="modelPerformanceChart"></canvas>
                </div>
                <div class="table-container">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Model Version</th>
                                <th>Total Diagnoses</th>
                                <th>Rated</th>
                                <th>Correct</th>
                                <th>Accuracy %</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in data.model_performance %}
                            <tr>
                                <td>{{ item.version }}</td>
                                <td>{{ item.total_diagnoses }}</td>
                                <td>{{ item.rated_count }}</td>
                                <td>{{ item.correct_count }}</td>
                                <td>{{ item.accuracy_pct|round(1) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block additional_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Most Common Diseases Chart
        const commonDiseasesData = {{ data.common_diseases|tojson }};
        const diseaseNames = commonDiseasesData.map(item => item.name);
        const diseaseCounts = commonDiseasesData.map(item => item.count);
        
        new Chart(document.getElementById('commonDiseasesChart'), {
            type: 'bar',
            data: {
                labels: diseaseNames,
                datasets: [{
                    label: 'Detection Count',
                    data: diseaseCounts,
                    backgroundColor: '#2e7d32',
                    borderColor: '#2e7d32',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false
            }
        });
        
        // Disease Trends Chart
        const diseaseTrendsData = {{ data.disease_trends|tojson }};
        
        // Group data by disease and date
        const diseases = [...new Set(diseaseTrendsData.map(item => item.disease))];
        const dates = [...new Set(diseaseTrendsData.map(item => item.date))].sort();
        
        // Create datasets for each disease
        const datasets = diseases.map((disease, index) => {
            const color = getColor(index);
            const data = dates.map(date => {
                const item = diseaseTrendsData.find(i => i.disease === disease && i.date === date);
                return item ? item.count : 0;
            });
            
            return {
                label: disease,
                data: data,
                backgroundColor: color,
                borderColor: color,
                borderWidth: 2,
                fill: false
            };
        });
        
        new Chart(document.getElementById('diseaseTrendsChart'), {
            type: 'line',
            data: {
                labels: dates,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Detection Ratio Chart
        const detectionRatioData = {{ data.detection_ratio|tojson }};
        const statusLabels = detectionRatioData.map(item => item.status);
        const statusCounts = detectionRatioData.map(item => item.count);
        
        new Chart(document.getElementById('detectionRatioChart'), {
            type: 'pie',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusCounts,
                    backgroundColor: [
                        '#e53935', '#2e7d32'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
        
        // Model Performance Chart
        const modelPerformanceData = {{ data.model_performance|tojson }};
        const versionLabels = modelPerformanceData.map(item => item.version);
        const accuracyPcts = modelPerformanceData.map(item => item.accuracy_pct);
        const totalDiagnoses = modelPerformanceData.map(item => item.total_diagnoses);
        
        new Chart(document.getElementById('modelPerformanceChart'), {
            type: 'bar',
            data: {
                labels: versionLabels,
                datasets: [
                    {
                        label: 'Accuracy %',
                        data: accuracyPcts,
                        backgroundColor: '#2e7d32',
                        borderColor: '#2e7d32',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Total Diagnoses',
                        data: totalDiagnoses,
                        backgroundColor: '#f57c00',
                        borderColor: '#f57c00',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Accuracy %'
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false
                        },
                        title: {
                            display: true,
                            text: 'Total Diagnoses'
                        }
                    }
                }
            }
        });
        
        // Helper function to get colors for multiple datasets
        function getColor(index) {
            const colors = [
                '#2e7d32', '#f57c00', '#0277bd', '#c2185b', 
                '#7b1fa2', '#00695c', '#ff5722', '#3949ab'
            ];
            return colors[index % colors.length];
        }
    });
</script>
{% endblock %}