{% extends 'reports/base_report.html' %}
{% set report_title = 'Intervention & Treatment Analysis' %}

{% block report_content %}
    <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle-fill me-2"></i>
        <strong>Note:</strong> This report contains simulated treatment effectiveness data. In the future, this will be replaced with actual farmer-reported treatment outcomes.
    </div>
    
    <div class="report-section">
        <h2 class="text-primary mb-4">Treatment Success Rates</h2>
        <div class="chart-container">
            <canvas id="treatmentSuccessChart"></canvas>
        </div>
        <div class="table-container mt-4">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Treatment</th>
                        <th>Success Rate (%)</th>
                        <th>Applications</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data.sample_data.treatment_success_rates %}
                    <tr>
                        <td>{{ item.treatment }}</td>
                        <td>{{ item.success_rate }}</td>
                        <td>{{ item.application_count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="report-section">
                <h2 class="text-primary mb-4">Disease-Specific Treatments</h2>
                <div class="chart-container">
                    <canvas id="diseaseSpecificChart"></canvas>
                </div>
                <div class="table-container mt-4">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Disease</th>
                                <th>Most Effective Treatment</th>
                                <th>Success Rate (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Simulated data -->
                            <tr>
                                <td>Coffee Leaf Rust</td>
                                <td>Copper-based Fungicide</td>
                                <td>87.2</td>
                            </tr>
                            <tr>
                                <td>Banana Bacterial Wilt</td>
                                <td>Plant Removal + Sterilization</td>
                                <td>93.5</td>
                            </tr>
                            <tr>
                                <td>Cassava Mosaic Disease</td>
                                <td>Resistant Varieties</td>
                                <td>96.8</td>
                            </tr>
                            <tr>
                                <td>Bean Anthracnose</td>
                                <td>Seed Treatment</td>
                                <td>82.3</td>
                            </tr>
                            <tr>
                                <td>Maize Lethal Necrosis</td>
                                <td>Crop Rotation</td>
                                <td>76.9</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="report-section">
                <h2 class="text-primary mb-4">Prevention Strategy Adoption</h2>
                <div class="chart-container">
                    <canvas id="preventionAdoptionChart"></canvas>
                </div>
                <div class="table-container mt-4">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Prevention Strategy</th>
                                <th>Adoption Rate (%)</th>
                                <th>Effectiveness (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Simulated data -->
                            <tr>
                                <td>Crop Rotation</td>
                                <td>68.3</td>
                                <td>82.7</td>
                            </tr>
                            <tr>
                                <td>Resistant Varieties</td>
                                <td>45.9</td>
                                <td>91.5</td>
                            </tr>
                            <tr>
                                <td>Field Sanitation</td>
                                <td>73.2</td>
                                <td>78.9</td>
                            </tr>
                            <tr>
                                <td>Regular Monitoring</td>
                                <td>89.5</td>
                                <td>86.2</td>
                            </tr>
                            <tr>
                                <td>Proper Spacing</td>
                                <td>81.7</td>
                                <td>74.1</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="report-section">
        <h2 class="text-primary mb-4">Before & After Analysis</h2>
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Most Improved Districts</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="improvedDistrictsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Most Improved Crops</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="improvedCropsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="alert alert-success">
            <strong>Key Insight:</strong> Implementing targeted interventions based on AgriModel AI recommendations has shown a 43% average reduction in disease prevalence across most affected districts.
        </div>
    </div>
{% endblock %}

{% block additional_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Treatment Success Rates Chart
        const treatmentData = {{ data.sample_data.treatment_success_rates|tojson }};
        const treatmentLabels = treatmentData.map(item => item.treatment);
        const successRates = treatmentData.map(item => item.success_rate);
        const applicationCounts = treatmentData.map(item => item.application_count);
        
        new Chart(document.getElementById('treatmentSuccessChart'), {
            type: 'bar',
            data: {
                labels: treatmentLabels,
                datasets: [
                    {
                        label: 'Success Rate (%)',
                        data: successRates,
                        backgroundColor: '#2e7d32',
                        borderColor: '#2e7d32',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Applications',
                        data: applicationCounts,
                        backgroundColor: '#f57c00',
                        borderColor: '#f57c00',
                        borderWidth: 1,
                        yAxisID: 'y1',
                        type: 'line'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Success Rate (%)'
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false
                        },
                        title: {
                            display: true,
                            text: 'Number of Applications'
                        }
                    }
                }
            }
        });
        
        // Disease-Specific Treatments Chart (Simulated data)
        const diseaseSpecificData = [
            { disease: 'Coffee Leaf Rust', treatment: 'Copper-based Fungicide', successRate: 87.2 },
            { disease: 'Banana Bacterial Wilt', treatment: 'Plant Removal + Sterilization', successRate: 93.5 },
            { disease: 'Cassava Mosaic Disease', treatment: 'Resistant Varieties', successRate: 96.8 },
            { disease: 'Bean Anthracnose', treatment: 'Seed Treatment', successRate: 82.3 },
            { disease: 'Maize Lethal Necrosis', treatment: 'Crop Rotation', successRate: 76.9 }
        ];
        
        new Chart(document.getElementById('diseaseSpecificChart'), {
            type: 'horizontalBar',
            data: {
                labels: diseaseSpecificData.map(item => item.disease),
                datasets: [{
                    label: 'Success Rate (%)',
                    data: diseaseSpecificData.map(item => item.successRate),
                    backgroundColor: [
                        '#2e7d32', '#a5d6a7', '#f57c00', '#ffcc80', '#0277bd'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
        
        // Prevention Strategy Adoption Chart (Simulated data)
        const preventionData = [
            { strategy: 'Crop Rotation', adoption: 68.3, effectiveness: 82.7 },
            { strategy: 'Resistant Varieties', adoption: 45.9, effectiveness: 91.5 },
            { strategy: 'Field Sanitation', adoption: 73.2, effectiveness: 78.9 },
            { strategy: 'Regular Monitoring', adoption: 89.5, effectiveness: 86.2 },
            { strategy: 'Proper Spacing', adoption: 81.7, effectiveness: 74.1 }
        ];
        
        new Chart(document.getElementById('preventionAdoptionChart'), {
            type: 'radar',
            data: {
                labels: preventionData.map(item => item.strategy),
                datasets: [
                    {
                        label: 'Adoption Rate (%)',
                        data: preventionData.map(item => item.adoption),
                        backgroundColor: 'rgba(46, 125, 50, 0.2)',
                        borderColor: '#2e7d32',
                        borderWidth: 2,
                        pointBackgroundColor: '#2e7d32'
                    },
                    {
                        label: 'Effectiveness (%)',
                        data: preventionData.map(item => item.effectiveness),
                        backgroundColor: 'rgba(245, 124, 0, 0.2)',
                        borderColor: '#f57c00',
                        borderWidth: 2,
                        pointBackgroundColor: '#f57c00'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20
                        }
                    }
                }
            }
        });
        
        // Improved Districts Chart (Simulated data)
        const improvedDistrictsData = [
            { district: 'Nyamagabe', before: 82, after: 37 },
            { district: 'Muhanga', before: 76, after: 41 },
            { district: 'Rubavu', before: 68, after: 32 },
            { district: 'Huye', before: 61, after: 29 }
        ];
        
        new Chart(document.getElementById('improvedDistrictsChart'), {
            type: 'bar',
            data: {
                labels: improvedDistrictsData.map(item => item.district),
                datasets: [
                    {
                        label: 'Before Intervention',
                        data: improvedDistrictsData.map(item => item.before),
                        backgroundColor: '#dc3545',
                        borderColor: '#dc3545',
                        borderWidth: 1
                    },
                    {
                        label: 'After Intervention',
                        data: improvedDistrictsData.map(item => item.after),
                        backgroundColor: '#2e7d32',
                        borderColor: '#2e7d32',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Disease Incidents'
                        }
                    }
                }
            }
        });
        
        // Improved Crops Chart (Simulated data)
        const improvedCropsData = [
            { crop: 'Coffee', before: 89, after: 42 },
            { crop: 'Banana', before: 72, after: 35 },
            { crop: 'Beans', before: 65, after: 31 },
            { crop: 'Cassava', before: 58, after: 27 }
        ];
        
        new Chart(document.getElementById('improvedCropsChart'), {
            type: 'bar',
            data: {
                labels: improvedCropsData.map(item => item.crop),
                datasets: [
                    {
                        label: 'Before Intervention',
                        data: improvedCropsData.map(item => item.before),
                        backgroundColor: '#dc3545',
                        borderColor: '#dc3545',
                        borderWidth: 1
                    },
                    {
                        label: 'After Intervention',
                        data: improvedCropsData.map(item => item.after),
                        backgroundColor: '#2e7d32',
                        borderColor: '#2e7d32',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Disease Incidents'
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}