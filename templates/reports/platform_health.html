{% extends 'reports/base_report.html' %}
{% set report_title = 'Platform Health & Support' %}

{% block report_content %}
    <div class="row">
        <div class="col-md-6">
            <div class="report-section">
                <h2 class="text-primary mb-4">Support Requests by Type</h2>
                <div class="chart-container">
                    <canvas id="supportTypeChart"></canvas>
                </div>
                <div class="table-container">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Request Type</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in data.support_by_type %}
                            <tr>
                                <td>{{ item.type }}</td>
                                <td>{{ item.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="report-section">
                <h2 class="text-primary mb-4">Support Requests by Status</h2>
                <div class="chart-container">
                    <canvas id="supportStatusChart"></canvas>
                </div>
                <div class="table-container">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in data.support_by_status %}
                            <tr>
                                <td>{{ item.status }}</td>
                                <td>{{ item.count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="report-section">
        <h2 class="text-primary mb-4">Resolution Performance</h2>
        <div class="row">
            <div class="col-md-4">
                <div class="card text-center mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Average Resolution Time</h5>
                        <p class="card-text display-4 text-primary">{{ data.avg_resolution_time_hours|round(1) }}</p>
                        <p class="text-muted">hours</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="report-section">
        <h2 class="text-primary mb-4">Model Ratings & Performance</h2>
        <div class="chart-container">
            <canvas id="modelRatingsChart"></canvas>
        </div>
        <div class="table-container">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Model Version</th>
                        <th>Average Rating</th>
                        <th>Rating Count</th>
                        <th>Correct Diagnoses</th>
                        <th>Incorrect Diagnoses</th>
                        <th>Accuracy %</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data.model_ratings %}
                    <tr>
                        <td>{{ item.version }}</td>
                        <td>{{ item.avg_rating|round(1) }}</td>
                        <td>{{ item.rating_count }}</td>
                        <td>{{ item.correct_count }}</td>
                        <td>{{ item.incorrect_count }}</td>
                        <td>{{ item.accuracy_pct|round(1) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block additional_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Support by Type Chart
        const supportTypeData = {{ data.support_by_type|tojson }};
        const typeLabels = supportTypeData.map(item => item.type);
        const typeCounts = supportTypeData.map(item => item.count);
        
        new Chart(document.getElementById('supportTypeChart'), {
            type: 'pie',
            data: {
                labels: typeLabels,
                datasets: [{
                    data: typeCounts,
                    backgroundColor: [
                        '#2e7d32', '#a5d6a7', '#f57c00', '#ffcc80', '#78909c'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
        
        // Support by Status Chart
        const supportStatusData = {{ data.support_by_status|tojson }};
        const statusLabels = supportStatusData.map(item => item.status);
        const statusCounts = supportStatusData.map(item => item.count);
        
        new Chart(document.getElementById('supportStatusChart'), {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusCounts,
                    backgroundColor: [
                        '#f57c00', '#2e7d32', '#78909c', '#e53935'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
        
        // Model Ratings Chart
        const modelRatingsData = {{ data.model_ratings|tojson }};
        const versionLabels = modelRatingsData.map(item => item.version);
        const avgRatings = modelRatingsData.map(item => item.avg_rating);
        const accuracyPcts = modelRatingsData.map(item => item.accuracy_pct);
        
        new Chart(document.getElementById('modelRatingsChart'), {
            type: 'bar',
            data: {
                labels: versionLabels,
                datasets: [
                    {
                        label: 'Avg. Rating (1-5)',
                        data: avgRatings,
                        backgroundColor: '#2e7d32',
                        borderColor: '#2e7d32',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Accuracy %',
                        data: accuracyPcts,
                        backgroundColor: '#f57c00',
                        borderColor: '#f57c00',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 5,
                        title: {
                            display: true,
                            text: 'Average Rating'
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        max: 100,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false
                        },
                        title: {
                            display: true,
                            text: 'Accuracy %'
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}