{% extends 'reports/base_report.html' %}
{% set report_title = 'Geographical Insights' %}

{% block additional_styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    #mapContainer {
        height: 500px;
        width: 100%;
        border-radius: 8px;
    }
    .legend {
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        line-height: 1.5;
    }
    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }
</style>
{% endblock %}

{% block report_content %}
    <div class="report-section">
        <h2 class="text-primary mb-4">Disease Distribution by Region</h2>
        <div id="mapContainer" class="mb-4"></div>
        <div class="alert alert-info">
            <i class="bi bi-info-circle-fill"></i> 
            The map shows disease concentration across districts. Darker colors indicate higher disease prevalence.
        </div>
    </div>
    
    <div class="report-section">
        <h2 class="text-primary mb-4">District-Level Disease Distribution</h2>
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="topDistrictsChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="diseaseByDistrictChart"></canvas>
                </div>
            </div>
        </div>
        <div class="table-container">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Province</th>
                        <th>District</th>
                        <th>Disease</th>
                        <th>Detection Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data.district_distribution %}
                    <tr>
                        <td>{{ item.province_name }}</td>
                        <td>{{ item.district_name }}</td>
                        <td>{{ item.disease_name }}</td>
                        <td>{{ item.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="report-section">
        <h2 class="text-primary mb-4">Most Active Districts</h2>
        <div class="chart-container">
            <canvas id="activeDistrictsChart"></canvas>
        </div>
        <div class="table-container mt-4">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Province</th>
                        <th>District</th>
                        <th>Diagnosis Count</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data.active_districts %}
                    <tr>
                        <td>{{ item.province_name }}</td>
                        <td>{{ item.district_name }}</td>
                        <td>{{ item.diagnosis_count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="report-section">
        <h2 class="text-primary mb-4">Disease Spread Analysis</h2>
        <div class="row">
            <div class="col-md-12">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Potential Disease Hotspots</strong>
                    <ul class="mb-0 mt-2">
                        {% set hotspots = data.district_distribution|groupby('disease_name', 'district_name')|sort(attribute='list|sum(attribute="count")', reverse=True)|slice(0, 3) %}
                        {% for hotspot in hotspots %}
                            <li>
                                <strong>{{ hotspot.grouper[0] }}</strong> in {{ hotspot.grouper[1] }} 
                                with {{ hotspot.list|sum(attribute="count") }} detections
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block additional_scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Map initialization would normally use actual GeoJSON data for Rwanda
        // This is a simplified version that creates a placeholder map
        const map = L.map('mapContainer').setView([-1.9403, 29.8739], 8); // Rwanda coordinates
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // In a real implementation, you would load GeoJSON for Rwanda districts
        // and color them based on disease prevalence
        // For demonstration, we'll add placeholder markers
        
        const districtData = {{ data.district_distribution|tojson }};
        
        // Group data by district
        const districts = {};
        districtData.forEach(item => {
            if (!districts[item.district_name]) {
                districts[item.district_name] = {
                    province: item.province_name,
                    totalCount: 0,
                    diseases: {}
                };
            }
            
            districts[item.district_name].totalCount += item.count;
            
            if (!districts[item.district_name].diseases[item.disease_name]) {
                districts[item.district_name].diseases[item.disease_name] = 0;
            }
            districts[item.district_name].diseases[item.disease_name] += item.count;
        });
        
        // This would normally use actual district coordinates
        // For demo purposes, we'll create random coordinates around Rwanda
        const rwandaCoords = [-1.9403, 29.8739];
        const districtCoords = {};
        
        Object.keys(districts).forEach((district, index) => {
            // Create semi-random coordinates around Rwanda center
            // In production, use actual district coordinates
            const angle = (index / Object.keys(districts).length) * Math.PI * 2;
            const radius = 0.5 + Math.random() * 0.5;
            const lat = rwandaCoords[0] + Math.cos(angle) * radius;
            const lng = rwandaCoords[1] + Math.sin(angle) * radius;
            
            districtCoords[district] = [lat, lng];
            
            // Determine color intensity based on disease count
            const maxCount = Math.max(...Object.values(districts).map(d => d.totalCount));
            const intensity = Math.min(0.9, 0.3 + (districts[district].totalCount / maxCount) * 0.7);
            const color = `rgba(220, 53, 69, ${intensity})`;
            
            // Create circle marker
            const marker = L.circleMarker([lat, lng], {
                radius: 10 + (districts[district].totalCount / maxCount) * 20,
                fillColor: color,
                color: '#fff',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);
            
            // Create popup content
            const diseases = Object.entries(districts[district].diseases)
                .sort((a, b) => b[1] - a[1])
                .map(([disease, count]) => `${disease}: ${count}`)
                .join('<br>');
                
            marker.bindPopup(`
                <strong>${district}, ${districts[district].province}</strong><br>
                Total detections: ${districts[district].totalCount}<br>
                <hr>
                <strong>Top diseases:</strong><br>
                ${diseases}
            `);
        });
        
        // Add legend
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function() {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <h6>Disease Prevalence</h6>
                <i style="background: rgba(220, 53, 69, 0.9)"></i> High<br>
                <i style="background: rgba(220, 53, 69, 0.6)"></i> Medium<br>
                <i style="background: rgba(220, 53, 69, 0.3)"></i> Low
            `;
            return div;
        };
        legend.addTo(map);
        
        // Top Districts Chart
        const activeDistrictsData = {{ data.active_districts|tojson }};
        const districtNames = activeDistrictsData.map(item => item.district_name);
        const districtCounts = activeDistrictsData.map(item => item.diagnosis_count);
        
        new Chart(document.getElementById('activeDistrictsChart'), {
            type: 'bar',
            data: {
                labels: districtNames,
                datasets: [{
                    label: 'Diagnosis Count',
                    data: districtCounts,
                    backgroundColor: '#2e7d32',
                    borderColor: '#2e7d32',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false
            }
        });
        
        // Top Districts by Disease Count
        const topDistrictsData = Object.entries(districts)
            .map(([district, data]) => ({
                district,
                province: data.province,
                count: data.totalCount
            }))
            .sort((a, b) => b.count - a.count)
            .slice(0, 8);
            
        new Chart(document.getElementById('topDistrictsChart'), {
            type: 'pie',
            data: {
                labels: topDistrictsData.map(item => item.district),
                datasets: [{
                    data: topDistrictsData.map(item => item.count),
                    backgroundColor: [
                        '#2e7d32', '#a5d6a7', '#f57c00', '#ffcc80', 
                        '#0277bd', '#81d4fa', '#c2185b', '#f48fb1'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    title: {
                        display: true,
                        text: 'Top Districts by Disease Count'
                    }
                }
            }
        });
        
        // Disease Distribution in Top Districts
        const topDiseases = [...new Set(districtData.map(item => item.disease_name))]
            .map(disease => {
                const count = districtData
                    .filter(item => item.disease_name === disease)
                    .reduce((sum, item) => sum + item.count, 0);
                return { disease, count };
            })
            .sort((a, b) => b.count - a.count)
            .slice(0, 5)
            .map(item => item.disease);
            
        const topDistrictNames = topDistrictsData.slice(0, 5).map(item => item.district);
        
        // Create datasets for each disease
        const diseaseDatasets = topDiseases.map((disease, index) => {
            return {
                label: disease,
                data: topDistrictNames.map(district => {
                    const item = districtData.find(item => 
                        item.district_name === district && item.disease_name === disease);
                    return item ? item.count : 0;
                }),
                backgroundColor: getColor(index),
                borderColor: getColor(index),
                borderWidth: 1
            };
        });
        
        new Chart(document.getElementById('diseaseByDistrictChart'), {
            type: 'bar',
            data: {
                labels: topDistrictNames,
                datasets: diseaseDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Disease Distribution in Top Districts'
                    }
                }
            }
        });
        
        // Helper function to get colors for multiple datasets
        function getColor(index) {
            const colors = [
                '#2e7d32', '#f57c00', '#0277bd', '#c2185b', 
                '#7b1fa2', '#00695c', '#ff5722', '#3949ab'
            ];
            return colors[index % colors.length];
        }
    });
</script>
{% endblock %}